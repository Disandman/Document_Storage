# Ревью от 19.08.2021

## Upload::getPathToFile

Чуть поправила обращения к методу, комментарии в коде.

## API

1. Добавила техническую страничку, чтобы было удобно отслеживать роуты системы и подшаманила немного с маршрутами REST в конфигах web.php.

В итоге довольно странные url-ы, такие как:

```
http://localhost/api_v1/upload
```

Превратились в более красивые

```
http://localhost/api/v1/upload
```

2. **Actions**

Проверила работоспособность методов. 

Метод PUT (actionUpdate) работает с ошибками:

- Передаваемые параметры не присваиваются (getBodyParams). Измененяется только файл. Если мне нужно поменять тип доступа к файлу, 
то я не могу это сделать, т.к. тип жёстко прописан, как 0.

- При каждом обращении файл - обязательный атрибут. Так быть не должно.

**Решение:**

- Сначала находим модель findModel. Если модели нет - выбрасывается исключение.
- Затем получаем массив измененных свойств getBodyParams.
- Загружаем массив в модель через load($params, ''), запускаем валидацию validate. Если есть ошибки - выкидываем исключение
- Сохраняем модель. 
- Если есть файл - записываем его на диск вместо старого файла. 
- Возращаем пользователю обновленную модель.

Метод POST (actionCreate) указывает всем по умолчанию тип доступности 0. А ведь это должно задаваться пользователем.

**Решение:**

- Создаем новую модель.
- Затем получаем массив переданных свойств getBodyParams.
- Загружаем массив в модель через load($params, ''), запускаем валидацию validate. Если есть ошибки - выкидываем исключение
- Проверяем наличие файла. Если его нет - выбрасываем исключение.
- Сохраняем модель. Записываем файо на диск.
- Возращаем пользователю созданную модель.

Код actionDelete тоже нужно немного "причесать". Я оставила там комментарии.

*__На заметку!__* Если что, всегда можно сверяться в очередности действий в методах-заглушках и смотреть исходники. Yii2 достаточно хорошо документирован, иногда даже с примерами в комментариях. Например, для rest есть actions по умолчанию. Лежат они по пути `vendor\yiisoft\yii2\rest\`. 

*__На заметку2!__* Очень удобно для отладки использовать xdebug. В контейнере я добавила настройку для его включения. Работает он на порту 9005.

Для разных сред разработки настраивается по-разному, на vs code, например, надо создать файл `.vscode\launch.json` и прописать в нём следующее:

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Listen for Xdebug",
            "type": "php",
            "request": "launch",
            "port": 9005,
            "pathMappings": {
                "/app": "Z:\\Work_git\\_\\EFKO-v2.1", 
            },
        }
    ]
}
```

Здесь `/app` - это расположение файлов приложения внутри докер-контейнера, а `Z:\\Work_git\\_\\EFKO-v2.1` - расположение на компьютере.

## Прочие замечания (функционал по большей части не ломает, но это следует учесть)

1. Уникальность именования

Вроде уже в очередной раз смотрю, а бывает умная мысль позже в голову приходит :)

Я про конструкцию:

```php
$file->saveAs(Upload::getPathToFile($file->name));
```

Т.к. все файлы складываются в одну папку, то второй файл с таким же именем перезапишет первый, как указано в доках к методу saveAs:

```
vendor\yiisoft\yii2\web\UploadedFile.php:169

If the target file `$file` already exists, it will be overwritten.
```

Чтобы это обойти можно:
- генерировать уникальный id или хэш для загружаемого файла, хранить его в базе и писать файл на диск с этим именем
- записать файл на диск с именем = id, обращаться по id

2. Документация методов

Для документирования кода в PHP есть стандарт [PHPDoc](https://ru.wikipedia.org/wiki/PHPDoc). И необходимо ему придерживаться.

Вот тут перечислены основные [теги по стандарту](https://github.com/php-fig/fig-standards/blob/master/proposed/phpdoc-tags.md#5-tags).

Для того, чтобы не писать всё руками, есть плагины для редакторов кода, которые собирают заготовки. 
Например, на VS Code [это плагин](https://marketplace.visualstudio.com/items?itemName=bmewburn.vscode-intelephense-client) включает себя такой функционал.

Так, комментарий из UploadController из этого:

```php
//////////////////////////////////Удаление объекта/////////////////////////////////////////////
    public function actionDelete($id)
    {
        //...
    }
```

превращается в это:

```php
    /**
     * Удаление объекта. 
     * Возвращает true при успехе или false при неудаче.
     *
     * @param int $id ID файла
     * @return boolean
     */
    public function actionDelete($id)
    {
        //...
    }
```

Редакторы кода при этом будут строить подсказки на основе документации при наведении на метод или при вводе входных параметров. Очень удобно.

3. Типизация

Начиная с 7ой версии PHP доступна типизация переменных, входных параметров и возвращаемого из функции результата. 

Надо стараться использовать типизацию. Типизация - друг программиста (хотя JS-еры могут и не согласиться :D ). 
Типизация позволяет однозначно определить тип переменных и функций, отпадает необходимость учитывать все варианты проверок. PHP ругнётся за нас :D

Типизированная функция из примера выше:

```php
    public function actionDelete(int $id): bool
    {
        // ...
    }
```

Если в эту функцию "кинуть" не int, она PHP ругнется на несоответствие типов.

4. Авторизация через гитхаб

При регистрации выбивает ошибку mysql вида:

```
SQLSTATE[HY000]: General error: 1364 Field 'password_hash' doesn't have a default value
The SQL being executed was: INSERT INTO `user` (`username`, `email`, `auth_key`, `registration_ip`, `created_at`, `updated_at`) VALUES ('annkirilenko', 'ann.kirilenko.18@gmail.com', 'QEmWQy58ZFVoTikxLJLaNDKosLECcZmz', '195.16.32.147', 1629447680, 1629447680)
```

Если исправить, то работает.


<p align="center">
    <a href="https://github.com/yiisoft" target="_blank">
        <img src="https://avatars0.githubusercontent.com/u/993323" height="100px">
    </a>
    <h1 align="center">Приложение для хранения документов на PHP (https://projectsil.ru)</h1>
    <h3 align="center">Необходимо разработать приложение, которое позволит организовывать хранение документов с различными разрешениями.</h3>
</p>


Требования к функционалу:
-------------------

○ Документы должны делиться на публичные (доступны «гостям»), условно-приватные (доступны авторизированным пользователям) и приватные (доступны только загрузившему пользователю).
</br>
○ Необходимо предусмотреть функционал авторизации и регистрации.
</br>
○ Необходимо вести некоторую статистику:
</br>
   − Сколько документов загружено в день / месяц / год
</br>
   − Соотношение публичных, условно-приватных и приватных документов за выбранный интервал времени.
</br>
○ Бекэнд должен быть написан на Yii2

Роли в системе:
-------------------

○ Гость – неавторизованный посетитель системы. Может просматривать публичные документы.
</br>
○ Необходимо предусмотреть функционал авторизации и регистрации.
</br>
○ Пользователь – посетитель, имеющий учетную запись в системе и авторизованный в ней. Может загружать свои документы, настраивать их приватность; просматривать публичные, условно-приватные и свои документы.
</br>
○ Администратор – пользователь, имеющий права на просмотр всех файлов и на управление другими пользователями.
INSTALLATION

Дополнительно (по желанию):
-------------------
○ Написание простых unit или acceptance тестов.
